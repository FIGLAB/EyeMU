import face_alignment
import cv2
import math

# //Yaw is the angle in the x-z plane with the vertical axis at the origin
# //Return is in radians. Turning the head left is a positive angle, right is a negative angle, 0 is head on.
def getYaw(facePoints):
    yaw=math.atan((facePoints[19][2]-facePoints[24][2])/(facePoints[19][0]-facePoints[24][0])) # Uses two cheek points
    return yaw

# //Pitch is the angle in the z-y plane with the horizontal axis at the origin
# //Return is in radians. Turning the head up is a positive angle, down is a negative angle, 0 is head on.
def getPitch(facePoints):
    # Use two points on forehead because it has a z normal vector
    pitch = math.atan((facePoints[30][2]-facePoints[27][2])/(facePoints[30][1]-facePoints[27][1]))
    return pitch

# // Roll is the angle in the x-y plane (face plane)
# // returns in radians.
def getRoll(facePoints):
    a = 30
    b = 33
    roll = math.atan2(facePoints[a][0]-facePoints[b][0], facePoints[a][1]-facePoints[b][1])
    return roll

def compare(preds, angles, ind):
    predYPR = [getYaw(preds[ind]), getPitch(preds[ind]), getRoll(preds[ind])]
    predYPR = [round(x, 4) for x in predYPR]
    print("predicted YPR: \t", predYPR)
    print("facemesh YPR: \t", [round(x,4) for x in angles[ind]])
    print()

fa = face_alignment.FaceAlignment(face_alignment.LandmarksType._3D, flip_input=False, device='cpu')

images = []
for name in ['one', 'two', 'three', 'four']:
    im = cv2.imread("andyfaceangles/" + name + ".PNG")
    images.append(im)

# yaw pitch roll
angles = [[-0.0119514518, 0.0081412053, -0.001885869],
          [ 0.0477603057, 0.5456582053, 0.0395602464],
          [-0.2717674276, 0.0724340367, -0.1382433023],
          [0.2503843238, -0.2095430583, 0.1116027060]]

preds = [
[[314.0, 659.0, -309.96929931640625], [333.0, 762.0, -311.3792419433594], [351.0, 855.0, -315.681640625], [379.0, 947.0, -310.2720642089844], [407.0, 1040.0, -280.1180725097656], [453.0, 1133.0, -209.6546630859375], [509.0, 1198.0, -116.87675476074219], [574.0, 1254.0, -33.49418640136719], [686.0, 1273.0, 2.88786244392395], [788.0, 1245.0, -18.087974548339844], [862.0, 1189.0, -93.57327270507812], [927.0, 1115.0, -178.64083862304688], [974.0, 1022.0, -240.97161865234375], [1011.0, 929.0, -266.8304138183594], [1020.0, 836.0, -268.84613037109375], [1039.0, 752.0, -262.5022888183594], [1048.0, 650.0, -260.8989562988281], [351.0, 585.0, 29.369714736938477], [388.0, 548.0, 97.92366790771484], [444.0, 539.0, 144.99114990234375], [500.0, 548.0, 173.77276611328125], [546.0, 557.0, 188.6453094482422], [742.0, 557.0, 202.0124053955078], [788.0, 539.0, 193.00367736816406], [844.0, 529.0, 170.87933349609375], [900.0, 529.0, 130.75482177734375], [955.0, 566.0, 67.18135833740234], [649.0, 678.0, 198.29583740234375], [649.0, 743.0, 235.19651794433594], [649.0, 817.0, 272.62652587890625], [649.0, 873.0, 276.1999206542969], [602.0, 920.0, 154.44471740722656], [621.0, 920.0, 179.22320556640625], [658.0, 929.0, 190.95118713378906], [686.0, 920.0, 185.05160522460938], [714.0, 920.0, 164.00601196289062], [426.0, 669.0, 55.42658996582031], [453.0, 650.0, 103.34451293945312], [500.0, 650.0, 107.5076904296875], [546.0, 669.0, 93.3565673828125], [509.0, 687.0, 99.95211029052734], [453.0, 687.0, 84.22410583496094], [760.0, 669.0, 107.42122650146484], [797.0, 641.0, 127.20611572265625], [844.0, 641.0, 129.01100158691406], [881.0, 659.0, 85.39249420166016], [844.0, 678.0, 110.26617431640625], [797.0, 678.0, 119.16680908203125], [565.0, 1059.0, 81.23179626464844], [593.0, 1031.0, 147.86537170410156], [639.0, 1013.0, 183.75820922851562], [658.0, 1013.0, 188.17019653320312], [686.0, 1013.0, 188.64353942871094], [732.0, 1022.0, 162.13836669921875], [769.0, 1050.0, 105.08099365234375], [732.0, 1078.0, 140.8515625], [704.0, 1096.0, 153.62330627441406], [667.0, 1105.0, 154.6338653564453], [630.0, 1096.0, 146.95999145507812], [593.0, 1087.0, 127.04389190673828], [565.0, 1059.0, 86.19564819335938], [630.0, 1050.0, 150.43865966796875], [658.0, 1040.0, 163.99282836914062], [695.0, 1040.0, 157.80575561523438], [769.0, 1050.0, 108.62489318847656], [695.0, 1059.0, 154.8460693359375], [667.0, 1059.0, 155.27279663085938], [630.0, 1059.0, 148.11329650878906]],
[[362.0, 679.0, -291.56243896484375], [380.0, 771.0, -266.6786804199219], [399.0, 845.0, -244.23074340820312], [426.0, 918.0, -214.03598022460938], [454.0, 983.0, -158.2989959716797], [500.0, 1038.0, -73.97058868408203], [555.0, 1047.0, 19.13348388671875], [638.0, 1038.0, 98.92655944824219], [729.0, 1056.0, 133.79527282714844], [831.0, 1056.0, 97.63330078125], [895.0, 1065.0, 13.78104305267334], [941.0, 1047.0, -79.49015045166016], [978.0, 983.0, -160.57810974121094], [1005.0, 909.0, -215.04339599609375], [1014.0, 836.0, -243.68736267089844], [1033.0, 753.0, -266.9559326171875], [1042.0, 670.0, -293.189453125], [435.0, 514.0, -33.094417572021484], [481.0, 468.0, 9.794638633728027], [527.0, 450.0, 43.90553665161133], [573.0, 450.0, 67.7677001953125], [619.0, 459.0, 81.85095977783203], [785.0, 450.0, 83.18219757080078], [831.0, 440.0, 69.5295639038086], [877.0, 450.0, 45.52992248535156], [932.0, 468.0, 11.40053939819336], [968.0, 514.0, -32.97138214111328], [711.0, 551.0, 112.53844451904297], [711.0, 597.0, 159.3336181640625], [711.0, 633.0, 209.88134765625], [711.0, 679.0, 226.98326110839844], [656.0, 744.0, 151.69955444335938], [684.0, 744.0, 169.3089141845703], [711.0, 744.0, 178.6087646484375], [739.0, 744.0, 168.50433349609375], [766.0, 744.0, 149.7214813232422], [500.0, 578.0, 15.29318904876709], [536.0, 560.0, 47.98356246948242], [582.0, 560.0, 49.63960647583008], [619.0, 578.0, 43.09441375732422], [582.0, 587.0, 54.07011413574219], [536.0, 587.0, 43.932220458984375], [794.0, 569.0, 45.26673126220703], [831.0, 560.0, 50.793392181396484], [867.0, 560.0, 49.048004150390625], [904.0, 578.0, 15.537455558776855], [867.0, 587.0, 44.3224983215332], [831.0, 587.0, 55.09309387207031], [619.0, 882.0, 146.34364318847656], [647.0, 836.0, 186.1236572265625], [693.0, 808.0, 201.31552124023438], [711.0, 808.0, 204.64353942871094], [739.0, 808.0, 199.203369140625], [785.0, 836.0, 176.79678344726562], [821.0, 882.0, 134.2763214111328], [785.0, 900.0, 173.3365020751953], [757.0, 909.0, 191.48561096191406], [720.0, 909.0, 196.48939514160156], [684.0, 909.0, 194.55673217773438], [656.0, 900.0, 180.49984741210938], [628.0, 882.0, 149.19256591796875], [684.0, 845.0, 186.711669921875], [711.0, 836.0, 192.18191528320312], [748.0, 845.0, 182.8685302734375], [812.0, 882.0, 136.73049926757812], [748.0, 872.0, 181.36968994140625], [720.0, 872.0, 185.86012268066406], [693.0, 872.0, 184.83192443847656]],
[[439.0, 609.0, -357.88983154296875], [464.0, 698.0, -353.36187744140625], [512.0, 778.0, -348.0849304199219], [512.0, 851.0, -335.9834289550781], [561.0, 900.0, -301.4998474121094], [544.0, 1005.0, -231.9820098876953], [528.0, 1029.0, -141.29466247558594], [524.0, 1049.0, -48.22966766357422], [637.0, 1049.0, 13.628859519958496], [1005.0, 843.0, 25.0051212310791], [1005.0, 851.0, -14.03801155090332], [924.0, 956.0, -69.35630798339844], [973.0, 916.0, -107.9549789428711], [1013.0, 859.0, -118.79169464111328], [1054.0, 778.0, -111.1736068725586], [1070.0, 714.0, -96.93560028076172], [1078.0, 641.0, -89.54442596435547], [342.0, 536.0, -43.877140045166016], [350.0, 512.0, 24.90365219116211], [391.0, 495.0, 81.29049682617188], [423.0, 504.0, 121.44732666015625], [464.0, 512.0, 146.978759765625], [641.0, 512.0, 221.24493408203125], [690.0, 495.0, 229.2691192626953], [747.0, 479.0, 226.7416534423828], [811.0, 487.0, 210.8709259033203], [876.0, 528.0, 173.30490112304688], [553.0, 641.0, 182.33546447753906], [536.0, 706.0, 210.70297241210938], [520.0, 762.0, 238.85418701171875], [512.0, 819.0, 237.93125915527344], [504.0, 859.0, 121.4701156616211], [520.0, 859.0, 146.420654296875], [544.0, 867.0, 164.0892333984375], [577.0, 867.0, 169.7673797607422], [609.0, 867.0, 162.55126953125], [383.0, 609.0, -0.5262351036071777], [399.0, 601.0, 50.9253044128418], [439.0, 601.0, 70.10150146484375], [488.0, 617.0, 70.91735076904297], [447.0, 633.0, 63.88603591918945], [407.0, 633.0, 35.349788665771484], [682.0, 625.0, 148.21775817871094], [714.0, 609.0, 179.863037109375], [755.0, 609.0, 197.39053344726562], [803.0, 617.0, 170.694091796875], [763.0, 633.0, 180.4813995361328], [714.0, 633.0, 171.08935546875], [480.0, 989.0, 38.465232849121094], [488.0, 956.0, 103.80729675292969], [520.0, 940.0, 147.72976684570312], [536.0, 948.0, 159.02944946289062], [561.0, 948.0, 166.4237518310547], [617.0, 964.0, 157.76010131835938], [674.0, 1005.0, 121.56881713867188], [625.0, 1021.0, 139.2399139404297], [585.0, 1029.0, 139.93374633789062], [553.0, 1029.0, 129.014892578125], [520.0, 1029.0, 111.36311340332031], [504.0, 1013.0, 84.9498291015625], [488.0, 989.0, 45.50112533569336], [520.0, 972.0, 118.98543548583984], [544.0, 972.0, 139.1097869873047], [577.0, 980.0, 142.998779296875], [666.0, 997.0, 120.43389129638672], [577.0, 1005.0, 140.4423370361328], [553.0, 1005.0, 130.83279418945312], [520.0, 997.0, 114.8595962524414]],
[[315.0, 667.0, -117.26466369628906], [343.0, 759.0, -142.98902893066406], [379.0, 832.0, -171.52699279785156], [407.0, 905.0, -187.90342712402344], [461.0, 996.0, -183.78411865234375], [535.0, 1070.0, -148.30462646484375], [617.0, 1133.0, -91.10321807861328], [717.0, 1170.0, -45.133663177490234], [809.0, 1179.0, -50.587650299072266], [882.0, 1152.0, -103.15129089355469], [918.0, 1097.0, -191.4464569091797], [937.0, 1033.0, -280.8262634277344], [955.0, 951.0, -341.5878601074219], [973.0, 850.0, -361.774658203125], [982.0, 768.0, -356.6141052246094], [1001.0, 686.0, -341.3147888183594], [1010.0, 585.0, -323.90264892578125], [480.0, 622.0, 182.92910766601562], [544.0, 585.0, 234.06454467773438], [608.0, 576.0, 257.7576599121094], [663.0, 585.0, 264.3964538574219], [717.0, 594.0, 257.7572937011719], [900.0, 594.0, 203.29421997070312], [937.0, 567.0, 183.0548553466797], [982.0, 549.0, 147.25650024414062], [1019.0, 540.0, 90.97334289550781], [1037.0, 558.0, 14.793742179870605], [809.0, 722.0, 209.00885009765625], [836.0, 795.0, 225.7403564453125], [845.0, 869.0, 244.5676727294922], [854.0, 914.0, 234.869140625], [772.0, 942.0, 147.72325134277344], [800.0, 951.0, 156.27049255371094], [836.0, 960.0, 151.9871826171875], [864.0, 942.0, 136.92352294921875], [873.0, 932.0, 113.98902893066406], [562.0, 704.0, 171.79046630859375], [608.0, 686.0, 207.13455200195312], [653.0, 677.0, 193.956298828125], [699.0, 704.0, 160.3325653076172], [653.0, 713.0, 178.79698181152344], [608.0, 722.0, 182.6378936767578], [882.0, 686.0, 105.9966812133789], [927.0, 658.0, 112.14280700683594], [973.0, 649.0, 95.959716796875], [991.0, 658.0, 40.54370880126953], [964.0, 686.0, 72.7979736328125], [927.0, 686.0, 99.20513153076172], [717.0, 1060.0, 92.5895004272461], [763.0, 1042.0, 135.36021423339844], [818.0, 1024.0, 148.7386474609375], [836.0, 1033.0, 141.80686950683594], [864.0, 1024.0, 133.14004516601562], [891.0, 1024.0, 90.23372650146484], [918.0, 1033.0, 25.963199615478516], [891.0, 1060.0, 66.59424591064453], [873.0, 1088.0, 86.69171142578125], [845.0, 1088.0, 100.56716918945312], [809.0, 1088.0, 110.16400909423828], [772.0, 1079.0, 111.68617248535156], [726.0, 1060.0, 94.6083984375], [809.0, 1060.0, 118.99154663085938], [836.0, 1051.0, 116.9442367553711], [854.0, 1042.0, 99.70401000976562], [909.0, 1033.0, 34.41970443725586], [864.0, 1042.0, 100.20789337158203], [836.0, 1051.0, 112.13217163085938], [809.0, 1051.0, 120.40620422363281]]
]

for i in range(4):
    compare(preds, angles, i)


# input = cv2.imread('00002/frames/00000small.jpg')
# preds = fa.get_landmarks(input)
#
# input2 = cv2.imread('00002/frames/00000.jpg')
# preds2 = fa.get_landmarks(input2)

# incopy = input.copy()
# for i, spot in enumerate(preds[0]):
#     landmarkSpot = (spot[0], spot[1])
#     print(i, spot)
#     incopy = cv2.putText(incopy, str(i), landmarkSpot, cv2.CHAIN_APPROX_SIMPLE, .5, (0,0,255))
#     incopy = cv2.circle(incopy, landmarkSpot, 2, (255,0,0))
#
# cv2.imshow("yea", incopy)
# cv2.waitKey(0)
# cv2.destroyAllWindows()
